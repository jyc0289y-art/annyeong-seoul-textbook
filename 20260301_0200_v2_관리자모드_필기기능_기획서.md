# 안녕, 서울 v2.0 — 관리자 모드 + 필기 기능 기획서

**작성일:** 2026-03-01 02:00
**버전:** 2.0
**상태:** 구현 완료

---

## 1. 프로젝트 현황 요약

### 완료된 작업 (v1.0 ~ v1.1)
| 항목 | 상태 | 비고 |
|------|------|------|
| PDF.js Canvas 뷰어 | ✅ | 한글/일본어 CJK 폰트 지원 |
| 11권 교재 카탈로그 | ✅ | 카테고리 필터 (basic~spinoff) |
| 저작권 보호 (우클릭/인쇄/복사 차단) | ✅ | copyright-guard.js |
| 워터마크 (사용자명 + 날짜) | ✅ | 대각선 타일 패턴 |
| 미리보기 3페이지 + 잠금 오버레이 | ✅ | pdf-lib로 추출 |
| AES-256-GCM PDF 암호화 | ✅ | 교재별 개별 키, Web Crypto API |
| GitHub Pages + Actions 배포 | ✅ | 빌드 19초 + 배포 9초 |
| 보안 취약점 해결 (Git dangling objects) | ✅ | 레포 삭제 + 재생성 |
| 데모 접근 코드 시스템 | ✅ | BOOKID2024, 만능코드: SEOULINK |

### 보안 검토 결과 (2026-03-01)
- 원본 PDF 직접 접근: 404 ✅
- 암호화 파일 헤더: PDF 시그니처 없음 ✅
- Git 히스토리: 원본 PDF 없음 ✅
- 소스코드 비밀 키: 없음 ✅

---

## 2. v2.0 신규 기능

### 기능 A: 관리자 모드 (Admin Mode)

#### 목적
교재 저자/교사가 별도 접근 코드 없이 전체 교재를 자유롭게 열람

#### 동작 방식
1. `#admin` URL로 관리자 로그인 페이지 접속
2. 비밀번호 입력 → SHA-256 해시 비교 인증
3. 인증 성공 → 카탈로그로 이동, ADMIN 배지 표시
4. 모든 교재의 전체 페이지 접근 가능 (미리보기 제한 해제)
5. "학생 모드" 토글로 학생 관점 테스트 가능

#### 기술 구현
| 항목 | 설명 |
|------|------|
| 인증 방식 | SHA-256 해시 비교 (Web Crypto API) |
| 세션 관리 | localStorage, 24시간 만료 |
| 학생 모드 | sessionStorage (탭 종료 시 초기화) |
| 접근 제어 | `checkAccess()` 함수에 관리자 바이패스 |
| UI 표시 | 카탈로그 헤더 ADMIN 배지 + 뷰어 툴바 소형 배지 |

#### 관련 파일
- `src/services/admin-service.js` (신규) — 인증 로직
- `src/pages/admin.js` (신규) — 로그인/패널 UI
- `src/main.js` (수정) — `#admin` 라우트 추가
- `src/services/access-code-service.js` (수정) — 관리자 바이패스
- `src/pages/catalog.js` (수정) — ADMIN 배지 + 관리자 설정 링크

---

### 기능 B: 필기 기능 (GoodNotes-like Annotation)

#### 목적
교재 위에 직접 필기하고 로컬에 저장 — iPad Apple Pencil 필압 지원

#### 동작 방식
1. 뷰어 하단 펜 아이콘(✏️) 클릭 → 필기 모드 활성화
2. 도구 모음 확장: 펜/형광펜/지우개/색상/굵기/되돌리기
3. 캔버스 위에 자유롭게 드로잉
4. 페이지 전환 시 자동 저장 (IndexedDB)
5. 브라우저 재접속 시 필기 데이터 복원

#### 필기 도구
| 도구 | 설명 |
|------|------|
| 펜 (✏️) | 필압 반응 (thinning: 0.5), 불투명 |
| 형광펜 | 균일 굵기, 반투명 30%, multiply 블렌딩 |
| 지우개 | 스트로크 단위 삭제 |
| 색상 | 빨강, 파랑, 초록, 주황, 보라, 검정 (6색) |
| 굵기 | 1~20px 슬라이더 |
| 되돌리기/다시실행 | Undo/Redo 스택 |
| 전체 지우기 | 확인 후 페이지 필기 삭제 |

#### 기술 구현
| 항목 | 설명 |
|------|------|
| 드로잉 엔진 | 네이티브 Canvas 2D API (외부 라이브러리 없음) |
| 필압 처리 | Pointer Events API (Apple Pencil, 터치, 마우스 통합) |
| 스트로크 렌더링 | perfect-freehand 알고리즘 인라인 (~3KB) |
| 데이터 저장 | IndexedDB (`annyeong-seoul-annotations`) |
| 저장 단위 | 페이지별 (`{bookId}-{pageNumber}` 키) |
| 자동 저장 | 스트로크 완료 시 + 페이지 전환 시 |

#### Canvas 레이어 구조
```
page-wrapper (position: relative)
├── pdf-canvas         (z-index: auto)  ← PDF 렌더링
├── annotation-canvas  (z-index: 10)    ← 필기 레이어
└── watermark-canvas   (z-index: 20)    ← 워터마크 (pointer-events: none)
```

#### 데이터 구조
```json
{
  "bookId": "hangul",
  "pageNumber": 3,
  "strokes": [
    {
      "tool": "pen",
      "color": "#ff0000",
      "size": 3,
      "opacity": 1.0,
      "points": [
        {"x": 100, "y": 200, "pressure": 0.6},
        {"x": 105, "y": 198, "pressure": 0.7}
      ]
    }
  ],
  "updatedAt": 1709258400000,
  "version": 1
}
```

#### 관련 파일
- `src/services/annotation-store.js` (신규) — IndexedDB CRUD
- `src/components/stroke-renderer.js` (신규) — 부드러운 스트로크 렌더링
- `src/components/annotation-canvas.js` (신규) — 드로잉 엔진 + Pointer Events
- `src/components/annotation-toolbar.js` (신규) — 플로팅 도구 모음 UI
- `src/pages/viewer.js` (수정) — 필기 시스템 통합

---

## 3. 파일 변경 요약

### 신규 파일 (7개)
| 파일 | 크기 | 용도 |
|------|------|------|
| `src/services/admin-service.js` | ~2KB | 관리자 SHA-256 인증 + 세션 |
| `src/pages/admin.js` | ~3KB | 관리자 로그인/패널 페이지 |
| `src/services/annotation-store.js` | ~4KB | IndexedDB 필기 저장소 |
| `src/components/stroke-renderer.js` | ~4KB | perfect-freehand 스트로크 렌더링 |
| `src/components/annotation-canvas.js` | ~7KB | 드로잉 엔진 (Pointer Events) |
| `src/components/annotation-toolbar.js` | ~3KB | 필기 도구 모음 UI |
| `scripts/generate-demo-keys.js` | ~1KB | 암호화 키 복사 스크립트 |

### 수정 파일 (5개)
| 파일 | 변경 내용 |
|------|----------|
| `src/main.js` | `#admin` 라우트 + import 추가 |
| `src/services/access-code-service.js` | 관리자 바이패스 로직 |
| `src/pages/catalog.js` | ADMIN 배지 + 관리자 설정 링크 |
| `src/pages/viewer.js` | 필기 캔버스/툴바 통합 + ADMIN 배지 |
| `src/styles/global.css` | 관리자 스타일 + 필기 툴바 스타일 (~170줄) |

### 설정 파일 (2개)
| 파일 | 변경 내용 |
|------|----------|
| `.gitignore` | `public/demo-keys.json` 추가 |
| `package.json` | `"build:keys"` 스크립트 추가 |

---

## 4. 기술 선택 근거

### 관리자 인증: SHA-256 해시 (Firebase 아닌 이유)
- Firebase 프로젝트가 아직 미설정 → 독립 동작 필수
- GitHub Pages 정적 사이트에서 서버사이드 인증 불가
- SHA-256 해시는 역산 불가 → 소스에 포함해도 안전
- 실질적 보안 경계는 AES-256-GCM 암호화 (관리자 비밀번호가 아님)

### 필기 라이브러리: 네이티브 Canvas (Fabric.js/Konva.js 아닌 이유)
- Fabric.js ~300KB / Konva.js ~170KB → 번들 크기 과대
- 필기에 필요한 것은 자유선 드로잉뿐 (객체 조작, SVG 파싱 불필요)
- perfect-freehand ~3KB 인라인으로 Apple Pencil 필압 대응
- 외부 의존성 0 → 장기 유지보수 용이

### 필기 저장: IndexedDB (localStorage 아닌 이유)
- localStorage: 5~10MB 제한, 동기식 (큰 데이터 시 UI 블로킹)
- IndexedDB: 수백MB 이상, 비동기, 바이너리 지원
- 100 스트로크/페이지 × 300 페이지 = ~15MB → IndexedDB가 적합

---

## 5. 사용 방법

### 관리자 모드 사용법
1. 브라우저에서 `사이트주소/#admin` 접속
2. 비밀번호 `seoulink2026` 입력 → 로그인
3. 카탈로그에서 ADMIN 배지 확인
4. 아무 교재 클릭 → 전체 페이지 접근 가능
5. 관리자 패널에서 "학생 모드" 토글 → 학생 관점 테스트

### 필기 기능 사용법
1. 교재 뷰어 하단의 ✏️ 버튼 클릭
2. 도구 선택: 펜 / 형광펜 / 지우개
3. 색상 및 굵기 설정
4. 교재 위에 자유롭게 드로잉
5. 페이지 전환 시 자동 저장
6. 되돌리기(↩) / 다시실행(↪) 지원

### 빌드 스크립트
```bash
# 암호화 키를 관리자용 demo-keys.json으로 복사
npm run build:keys

# 개발 서버 실행
npm run dev

# 프로덕션 빌드
npm run build
```

---

## 6. 향후 계획

| 단계 | 내용 | 상태 |
|------|------|------|
| Phase 1 | 코어 뷰어 + 암호화 + 배포 | ✅ 완료 |
| **Phase 2** | **관리자 모드 + 필기 기능** | **✅ 이번 작업** |
| Phase 3 | Firebase 프로젝트 설정 + Firestore 통합 | 미착수 |
| Phase 4 | 교사 대시보드 + 학습 로그 | 미착수 |
| Phase 5 | 계정 관리 + 법률 문서 (GDPR/APPI) | 미착수 |
| Phase 6 | KoreanClassGame RPG 연동 | 미착수 |

---

*이 기획서는 Claude Code에 의해 자동 생성되었습니다.*
