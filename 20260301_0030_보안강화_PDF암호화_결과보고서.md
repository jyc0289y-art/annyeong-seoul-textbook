# 보안 강화: PDF 암호화 + 미리보기 시스템 — 결과보고서

**작업일시**: 2026-02-28 23:00 ~ 2026-03-01 00:30 (KST)
**작업자**: Claude + jyc

---

## 1. 문제점 (발견 시점: 2026-02-28)

### 치명적 보안 취약점
원본 PDF 파일이 GitHub Pages에 그대로 배포되어, 아래 URL로 **누구나 원본 교재를 직접 다운로드** 가능했음:

```
https://jyc0289y-art.github.io/annyeong-seoul-textbook/pdfs/hangul.pdf
```

- 우클릭 차단, 워터마크, 접근 코드 등 모든 보호 조치가 **클라이언트(브라우저) 측**이라 쉽게 우회 가능
- Git 히스토리에도 원본 PDF가 남아있어 과거 커밋에서 추출 가능

### 접근 기록 조사 결과
- GitHub Traffic API 확인: **조회 0명 / 클론 0건 / Fork 0건**
- 레포 생성 30분 후 발견 → 외부 접근 가능성 극히 낮음

---

## 2. 해결 방법

### AES-256-GCM 빌드 타임 암호화
- 원본 PDF를 AES-256-GCM으로 암호화 후 `.enc` 파일로 변환
- 교재별 개별 암호화 키 사용 (한 권 키 유출 시 다른 교재는 안전)
- 암호화 키(`scripts/keys.json`)는 `.gitignore`로 Git에서 제외
- 원본 PDF(`public/pdfs/`)도 `.gitignore`로 Git에서 제외

### 미리보기 PDF 시스템
- 각 교재의 1~3페이지를 별도 PDF로 추출 (`public/previews/`)
- 미리보기는 암호화 없이 자유 열람 가능
- 전체 교재 열람은 로그인 + 접근 코드 + 복호화 필요

---

## 3. 구현 내용

### 새로 생성한 파일

| 파일 | 용도 |
|------|------|
| `scripts/encrypt-pdfs.js` | PDF → AES-256-GCM 암호화 (교재별 개별 키) |
| `scripts/generate-previews.js` | PDF 1~3페이지 → 미리보기 PDF 추출 (pdf-lib) |
| `src/services/pdf-decrypt-service.js` | Web Crypto API 기반 클라이언트 복호화 |
| `src/services/access-code-service.js` | Firestore 기반 접근 코드 검증 (데모 폴백 포함) |

### 수정한 파일

| 파일 | 변경 내용 |
|------|----------|
| `src/pages/viewer.js` | 이중 모드: 미리보기 PDF / 암호화된 전체 PDF |
| `src/config/books.js` | `encryptedFile`, `previewFile` 필드 추가 (11권) |
| `.gitignore` | `public/pdfs/`, `scripts/keys.json` 제외 |
| `package.json` | `pdf-lib` 추가, 빌드 스크립트 추가 |
| `.github/workflows/deploy.yml` | 원본 PDF 삭제 안전장치 추가 |

### 암호화 결과 (11권)

| 교재 | 암호화 파일 | 미리보기 파일 |
|------|-----------|-------------|
| hangul | hangul.enc (938KB) | hangul-preview.pdf (309KB) |
| beginner | beginner.enc (1.7MB) | beginner-preview.pdf (454KB) |
| inter1 | inter1.enc (1.4MB) | inter1-preview.pdf (509KB) |
| inter2 | inter2.enc (2.2MB) | inter2-preview.pdf (565KB) |
| inter3 | inter3.enc (1.1MB) | inter3-preview.pdf (339KB) |
| adv1 | adv1.enc (1.2MB) | adv1-preview.pdf (384KB) |
| adv2 | adv2.enc (605KB) | adv2-preview.pdf (233KB) |
| adv3 | adv3.enc (824KB) | adv3-preview.pdf (328KB) |
| spinA | spinA.enc (1.1MB) | spinA-preview.pdf (453KB) |
| spinB | spinB.enc (979KB) | spinB-preview.pdf (397KB) |
| spinC | spinC.enc (1.0MB) | spinC-preview.pdf (427KB) |

---

## 4. 배포 및 검증

### Git 히스토리 정리
- 기존 `.git` 폴더 삭제 (원본 PDF가 포함된 히스토리 제거)
- 새 git 저장소 초기화 → 클린 커밋 1개로 시작
- 기존 레포에 `--force` push → 이전 히스토리 완전 교체

### 보안 검증 결과

| 검증 항목 | 기대 | 결과 |
|-----------|------|------|
| `pdfs/hangul.pdf` 직접 접근 | 404 | ✅ **404** |
| `pdfs-encrypted/hangul.enc` 접근 | 200 (암호화 바이너리) | ✅ **200** (무용지물) |
| `previews/hangul-preview.pdf` 접근 | 200 | ✅ **200** |
| Git 히스토리에 원본 PDF | 없음 | ✅ **없음** |
| 카탈로그 페이지 | 11권 표시 | ✅ **정상** |
| 미리보기 모드 | 1~3페이지 + Preview 워터마크 | ✅ **정상** |
| 4페이지 이후 접근 | 불가능 | ✅ **물리적 차단** (미리보기 PDF에 3페이지만 존재) |

### GitHub Actions 빌드
- 빌드: 19초 / 배포: 9초 — 전체 성공 ✅

---

## 5. 보안 효과 비교

| 항목 | 변경 전 (위험) | 변경 후 |
|------|--------------|---------|
| 직접 URL 다운로드 | ⛔ PDF 원본 다운로드 가능 | ✅ 404 또는 암호화 바이너리 |
| 미리보기 | ⛔ 전체 PDF 로드 후 페이지만 차단 | ✅ 3페이지 PDF만 제공 (물리적 제한) |
| Git 히스토리 | ⛔ 과거 커밋에서 PDF 추출 가능 | ✅ 히스토리 초기화, 원본 없음 |
| 접근 코드 | ⛔ 클라이언트 하드코딩 | ✅ Firestore 서버 검증 준비 완료 |
| localStorage 조작 | ⛔ 콘솔에서 권한 부여 가능 | ✅ Firestore 권한 확인 준비 완료 |

---

## 6. 뷰어 동작 모드

| 모드 | 대상 | 데이터 소스 | 인증 필요 |
|------|------|-----------|----------|
| 미리보기 | 1~3페이지 | `previews/{bookId}-preview.pdf` | ✗ |
| 전체 열람 | 전체 페이지 | `pdfs-encrypted/{bookId}.enc` → 복호화 | ✓ (로그인 + 접근 코드) |
| 로컬 개발 | 전체 페이지 | `pdfs/{bookId}.pdf` (로컬에만 존재) | ✗ |

---

## 7. 암호화 기술 상세

### 암호화 알고리즘
- **AES-256-GCM** (Authenticated Encryption)
- 키: 256비트 (32바이트) — 교재별 개별 생성
- IV: 96비트 (12바이트) — 교재별 개별 생성
- 인증 태그: 128비트 (16바이트)

### 암호화 파일 형식
```
[12바이트 IV] + [16바이트 authTag] + [암호화된 데이터]
```

### 복호화 흐름
```
1. Firebase Auth 인증 확인
2. Firestore에서 접근 권한 확인
3. Firestore에서 복호화 키(key, iv, authTag) 조회
4. pdfs-encrypted/{bookId}.enc 다운로드
5. Web Crypto API로 AES-256-GCM 복호화
6. PDF.js로 Canvas 렌더링
```

---

## 8. 남은 작업

### 필수 (사용자가 직접 수행)
1. **Firebase 프로젝트 생성** → Firestore, Authentication 활성화
2. **암호화 키를 Firestore에 업로드** (`scripts/keys.json` → `encryptionKeys/{bookId}`)
3. **GitHub 기존 레포 삭제** (sudo 모드 이메일 인증 필요)
   - 브라우저: github.com/jyc0289y-art/annyeong-seoul-textbook/settings → Danger Zone → Delete
   - 삭제 후 같은 이름으로 새 레포 생성하면 더 깨끗함

### 권장
4. Firebase Security Rules 설정 (encryptionKeys 읽기 제한)
5. 접근 코드를 Firestore `accessCodes` 컬렉션으로 이전
6. 데모 모드를 프로덕션 Firestore 모드로 전환

---

## 9. 파일 구조 (현재)

```
annyeong-seoul-textbook/
├── .github/workflows/deploy.yml    ← GitHub Actions 배포
├── .gitignore                       ← pdfs/, keys.json 제외
├── public/
│   ├── pdfs/                        ← ⛔ Git 미포함 (로컬에만 존재)
│   │   ├── hangul.pdf ~ spinC.pdf
│   ├── pdfs-encrypted/              ← ✅ Git 포함 (암호화된 바이너리)
│   │   ├── hangul.enc ~ spinC.enc
│   └── previews/                    ← ✅ Git 포함 (3페이지 미리보기)
│       ├── hangul-preview.pdf ~ spinC-preview.pdf
│       └── manifest.json
├── scripts/
│   ├── encrypt-pdfs.js              ← 암호화 스크립트
│   ├── generate-previews.js         ← 미리보기 생성 스크립트
│   └── keys.json                    ← ⛔ Git 미포함 (로컬에만 존재)
├── src/
│   ├── services/
│   │   ├── pdf-decrypt-service.js   ← Web Crypto API 복호화
│   │   └── access-code-service.js   ← 접근 코드 검증
│   ├── pages/viewer.js              ← 이중 모드 뷰어
│   └── ...
└── package.json                     ← pdf-lib 추가, 빌드 스크립트
```

---

**배포 URL**: https://jyc0289y-art.github.io/annyeong-seoul-textbook/
**GitHub 레포**: https://github.com/jyc0289y-art/annyeong-seoul-textbook
