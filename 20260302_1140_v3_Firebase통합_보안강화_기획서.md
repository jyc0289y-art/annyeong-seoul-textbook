# 안녕, 서울 v3.0 — Phase 3: Firebase 통합 (보안 + 인증) 기획서

**작성일:** 2026-03-02
**버전:** v3.0 (Phase 3)
**작성:** Claude Code + jyc

---

## 1. 개요

### 1.1 목적
Phase 2에서 발견된 보안 취약점을 해결하기 위해 Firebase를 실제 통합합니다.

### 1.2 해결된 보안 문제

| 문제 | Phase 2 (이전) | Phase 3 (이번) |
|------|---|---|
| 복호화 키 노출 | `demo-keys.json` 공개 접근 가능 | Firestore + 인증 + 접근 규칙 |
| 로그인 | 데모 모드 (가짜 사용자) | Firebase Auth (Google) |
| 접근 코드 검증 | 클라이언트 로컬 검증 (위변조 가능) | Firestore 서버사이드 검증 |
| 권한 관리 | localStorage (위변조 가능) | Firestore (서버 보호) |

---

## 2. Firebase 프로젝트 구성

### 2.1 프로젝트 정보
- **프로젝트명:** annyeong-seoul
- **프로젝트 ID:** annyeong-seoul
- **계정:** jyc0289y@gmail.com
- **리전:** asia-northeast3 (Seoul)
- **요금제:** Spark (무료)

### 2.2 활성화된 서비스
- **Authentication:** Google 로그인 제공업체
- **Cloud Firestore:** 프로덕션 모드, Seoul 리전
- **웹앱:** annyeong-seoul-web (등록 완료)

---

## 3. Firestore 데이터 구조

### 3.1 encryptionKeys/{bookId}
교재별 AES-256-GCM 암호화 키 저장

```
{
  key: string (Base64),
  iv: string (Base64),
  authTag: string (Base64),
  uploadedAt: timestamp
}
```

### 3.2 accessCodes/{codeId}
접근 코드 관리

```
{
  code: string,
  bookId: string (빈 문자열 = 전체 교재),
  active: boolean,
  maxUses: number (0 = 무제한),
  currentUses: number,
  createdAt: timestamp,
  description: string
}
```

### 3.3 userAccess/{userId_bookId}
사용자별 접근 권한 기록

```
{
  userId: string,
  bookId: string,
  code: string,
  grantedAt: timestamp,
  status: 'active' | 'expired' | 'revoked'
}
```

---

## 4. Firestore 보안 규칙

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 암호화 키: 인증 + 접근 권한 필요
    match /encryptionKeys/{bookId} {
      allow read: if request.auth != null &&
        exists(.../userAccess/$(request.auth.uid + '_' + bookId));
      allow write: if false;
    }

    // 접근 코드: 인증된 사용자만 읽기
    match /accessCodes/{codeId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // 사용자 접근: 자신의 것만 읽기/생성
    match /userAccess/{docId} {
      allow read: if auth != null && resource.data.userId == auth.uid;
      allow create: if auth != null && request.resource.data.userId == auth.uid;
      allow update, delete: if false;
    }
  }
}
```

---

## 5. 수정/생성된 파일

### 5.1 신규 파일
| 파일 | 용도 |
|------|------|
| `.env.local` | Firebase config (gitignored) |
| `firebase.json` | Firebase 프로젝트 설정 |
| `.firebaserc` | Firebase 프로젝트 연결 |
| `firestore.rules` | Firestore 보안 규칙 |
| `firestore.indexes.json` | Firestore 인덱스 (accessCodes 쿼리) |
| `scripts/upload-keys-to-firestore.js` | 키 + 접근코드 Firestore 업로드 |

### 5.2 수정 파일
| 파일 | 변경 내용 |
|------|----------|
| `src/firebase.js` | 환경변수 기반 config, 플레이스홀더 제거 |
| `src/services/pdf-decrypt-service.js` | `getKeyFromFirestore()` 실제 구현 |
| `src/services/access-code-service.js` | Firestore 접근 코드/권한 관리 구현 |
| `.github/workflows/deploy.yml` | Firebase config secrets + env 주입 |
| `.gitignore` | `.firebase/`, `firebase-debug.log` 추가 |

---

## 6. 배포 전 필수 작업

### 6.1 GitHub Secrets 설정 (리포지토리 Settings > Secrets)
```
FIREBASE_API_KEY = AIzaSyChI4Ghr5WQlStIm2pWorBqxaZmhrmBdc0
FIREBASE_AUTH_DOMAIN = annyeong-seoul.firebaseapp.com
FIREBASE_PROJECT_ID = annyeong-seoul
FIREBASE_STORAGE_BUCKET = annyeong-seoul.firebasestorage.app
FIREBASE_MESSAGING_SENDER_ID = 22451018345
FIREBASE_APP_ID = 1:22451018345:web:231d69df87df8f955860f8
```

### 6.2 Firestore 데이터 업로드
```bash
# 터미널에서 실행
npx firebase login
node scripts/upload-keys-to-firestore.js
```

### 6.3 GitHub Pages 도메인 승인 (Firebase Auth)
Firebase Console > Authentication > 설정 > 승인된 도메인에 추가:
- `jyc0289y-art.github.io`

---

## 7. 호환성 (점진적 전환)

- Firebase 미설정 환경 → 기존 데모 모드 자동 폴백
- Firestore 키 로드 실패 → demo-keys.json 폴백
- Firestore 접근코드 검증 실패 → 데모 코드도 허용
- 관리자 모드 → 기존과 동일하게 동작
- 필기 기능 → 기존과 동일하게 동작 (IndexedDB)
